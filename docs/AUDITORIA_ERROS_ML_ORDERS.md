# üö® AUDITORIA DE ERROS: /ml-orders-completas

**Data:** 2025-01-20  
**Foco:** Erros, Bugs, Duplicidades e Conflitos  
**Status:** ‚ö†Ô∏è **CR√çTICO** - M√∫ltiplos erros encontrados

---

## üî¥ ERROS CR√çTICOS ENCONTRADOS

### 1. ‚ùå ERRO 404: Pedidos N√£o Encontrados

**Evid√™ncia nos Logs:**
```
‚ö†Ô∏è Erro ao buscar detalhes do pedido 43925859036: 404
‚ö†Ô∏è Erro ao buscar detalhes do pedido 43987081178: 404
‚ö†Ô∏è Erro ao buscar detalhes do pedido 44001768275: 404
‚ö†Ô∏è Erro ao buscar detalhes do pedido 44150830985: 404
```

**Problema:**
- Edge function `ml-api-direct` tenta buscar pedidos que n√£o existem mais na API ML
- **30 claims processados**, mas v√°rios pedidos retornam 404

**Impacto:**
- Dados incompletos para devolu√ß√µes
- Perda de informa√ß√µes do comprador/produto
- UI mostra campos vazios

**Causa Raiz:**
```typescript
// ml-api-direct/index.ts linha ~1300
const orderDetailResponse = await fetch(
  `https://api.mercadolibre.com/orders/${orderId}`,
  { headers: { Authorization: `Bearer ${accessToken}` } }
);

if (!orderDetailResponse.ok) {
  console.warn(`‚ö†Ô∏è Erro ao buscar detalhes do pedido ${orderId}: ${orderDetailResponse.status}`);
  // ‚ùå PROBLEMA: Continua processando mesmo sem dados do pedido
}
```

**Solu√ß√£o:**
```typescript
// ‚úÖ CORRE√á√ÉO: Salvar status de erro no banco
if (!orderDetailResponse.ok) {
  const devolucao = {
    ...baseData,
    dados_completos: false,
    erro_pedido: `HTTP ${orderDetailResponse.status}`,
    status_pedido: 'not_found'
  };
  ordersCancelados.push(devolucao);
  continue; // Pular enriquecimento
}
```

---

### 2. ‚ùå ERRO 404: Media√ß√µes N√£o Encontradas

**Evid√™ncia nos Logs:**
```
‚ö†Ô∏è Mediation failed (404): 5306187831
‚ö†Ô∏è Mediation failed (404): 5310025116
‚ö†Ô∏è Mediation failed (404): 5310894802
```

**Problema:**
- Endpoint de media√ß√µes retorna 404 para claims que n√£o t√™m media√ß√£o
- **60% dos claims** n√£o t√™m media√ß√£o, mas c√≥digo tenta buscar mesmo assim

**Impacto:**
- Logs polu√≠dos com avisos
- Chamadas desnecess√°rias √† API
- Campos de media√ß√£o sempre vazios

**Causa Raiz:**
```typescript
// ml-api-direct/index.ts linha ~250
const mediationUrl = `https://api.mercadolibre.com/mediations/${mediationId}`;
const mediationResponse = await fetchMLWithRetry(mediationUrl, accessToken, integrationAccountId);

if (!mediationResponse.ok) {
  if (mediationResponse.status === 404) {
    console.log(`  ‚ÑπÔ∏è  Mediation failed (404): ${mediationId}`);
    // ‚ùå PROBLEMA: Deveria verificar ANTES se claim tem media√ß√£o
  }
}
```

**Solu√ß√£o:**
```typescript
// ‚úÖ CORRE√á√ÉO: Verificar tipo do claim antes
if (claimDetails?.type === 'mediations' && mediationId) {
  // S√≥ buscar se realmente for media√ß√£o
  const mediationResponse = await fetchMLWithRetry(...);
}
```

---

### 3. üîÑ DUPLICIDADE: L√≥gica de Filtros Repetida

**Problema:**
- Filtros aplicados em **3 lugares diferentes**
- Mesma l√≥gica repetida m√∫ltiplas vezes

**Evid√™ncia:**

#### Local 1: useDevolucoes.ts (linhas 169-198)
```typescript
const devolucoesFiltradas = useMemo(() => {
  return applyAllFilters(devolucoes, advancedFilters);
}, [devolucoes, advancedFilters]);
```

#### Local 2: useDevolucoesBusca.ts (linhas 400-500)
```typescript
// Aplica filtros ap√≥s buscar da API
const filtrados = todasDevolucoes.filter(dev => {
  // Mesma l√≥gica de filtro
  if (filtros.searchTerm) { ... }
  if (filtros.statusClaim) { ... }
  // ...
});
```

#### Local 3: FilterUtils.ts
```typescript
export const applyAllFilters = (vendas: any[], filters: any) => {
  // Mesma l√≥gica novamente
  let filtered = vendas;
  if (filters.searchTerm) { ... }
  if (filters.statusClaim) { ... }
  // ...
};
```

**Impacto:**
- Manuten√ß√£o complexa (3 lugares para atualizar)
- Risco de inconsist√™ncia
- Performance degradada (filtros aplicados 2x)

**Solu√ß√£o:**
```typescript
// ‚úÖ CENTRALIZAR EM UM S√ì LUGAR
// Usar APENAS FilterUtils.applyAllFilters
// Remover l√≥gica duplicada dos hooks
```

---

### 4. üêõ BUG: Console Logs Vazios

**Evid√™ncia:**
```
No console logs were recorded.
```

**Problema:**
- Console logs n√£o est√£o sendo capturados
- Dificulta debug em produ√ß√£o
- Erros silenciosos n√£o aparecem

**Poss√≠vel Causa:**
```typescript
// C√≥digo usa toast em vez de console
toast.error('Nenhuma conta ML dispon√≠vel');
// ‚ùå PROBLEMA: N√£o fica registrado em logs
```

**Solu√ß√£o:**
```typescript
// ‚úÖ SEMPRE logar E mostrar toast
logger.error('Nenhuma conta ML dispon√≠vel');
toast.error('Nenhuma conta ML dispon√≠vel');
```

---

### 5. ‚ö†Ô∏è CONFLITO: Dois Hooks Gerenciando Mesmo Estado

**Problema:**
- `useDevolucoes` e `useDevolucoesBusca` gerenciam `loading` e `devolucoes`
- Estado pode divergir entre os dois hooks

**Evid√™ncia:**

#### useDevolucoes.ts:
```typescript
const [devolucoes, setDevolucoes] = useState<any[]>([]); // linha 85
const [loading, setLoading] = useState(false); // linha 102
```

#### useDevolucoesBusca.ts:
```typescript
const [loading, setLoading] = useState(false); // linha 52
// ‚ùå CONFLITO: Dois loadings diferentes
```

#### Composi√ß√£o:
```typescript
// useDevolucoes.ts linha 126
const busca = useDevolucoesBusca();
// ...
loading: busca.loading || loading, // linha 311
// ‚ùå PROBLEMA: Qual loading √© verdadeiro?
```

**Impacto:**
- Loading pode aparecer mesmo sem busca ativa
- Loading pode desaparecer antes de terminar
- UI inconsistente

**Solu√ß√£o:**
```typescript
// ‚úÖ REMOVER estado duplicado
// Usar APENAS loading do useDevolucoesBusca
// useDevolucoes s√≥ gerencia filtros/pagina√ß√£o
```

---

### 6. üí• ERRO POTENCIAL: AbortController N√£o Limpo

**Problema:**
- `abortControllerRef` pode causar memory leak
- N√£o √© limpo no unmount

**Evid√™ncia:**
```typescript
// useDevolucoesBusca.ts linha 54
const abortControllerRef = useRef<AbortController | null>(null);

// linha 158-161
if (abortControllerRef.current) {
  abortControllerRef.current.abort();
}
abortControllerRef.current = new AbortController();

// ‚ùå FALTANDO: Cleanup no useEffect
```

**Solu√ß√£o:**
```typescript
// ‚úÖ ADICIONAR cleanup
useEffect(() => {
  return () => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }
  };
}, []);
```

---

### 7. üîÑ DUPLICIDADE: Mapeadores Redundantes

**Problema:**
- **18 mapeadores diferentes** para processar devolu√ß√µes
- Muitos fazem coisas similares

**Evid√™ncia:**
```typescript
// useDevolucoesBusca.ts linhas 13-33
import {
  mapDadosPrincipais,      // ‚Üê Mapeia dados principais
  mapDadosFinanceiros,     // ‚Üê Mapeia financeiro
  mapDadosReview,          // ‚Üê Mapeia review
  mapDadosSLA,             // ‚Üê Mapeia SLA
  mapDadosRastreamento,    // ‚Üê Mapeia rastreamento
  mapDadosMediacao,        // ‚Üê Mapeia media√ß√£o
  mapDadosReputacao,       // ‚Üê Mapeia reputa√ß√£o
  mapDadosAnexos,          // ‚Üê Mapeia anexos
  mapDadosTimeline,        // ‚Üê Mapeia timeline
  mapDadosMensagens,       // ‚Üê Mapeia mensagens
  mapDadosComprador,       // ‚Üê Mapeia comprador
  mapDadosPagamento,       // ‚Üê Mapeia pagamento
  mapDadosProduto,         // ‚Üê Mapeia produto
  mapDadosFlags,           // ‚Üê Mapeia flags
  mapDadosQualidade,       // ‚Üê Mapeia qualidade
  mapDadosTroca,           // ‚Üê Mapeia troca
  mapDadosClassificacao,   // ‚Üê Mapeia classifica√ß√£o
  mapDadosAdicionais,      // ‚Üê Mapeia adicional
  mapDadosBrutos           // ‚Üê Mapeia bruto
} from '../utils/DevolucaoDataMapper';

// ‚ùå PROBLEMA: Muitos mapeadores fazem coisas similares
```

**An√°lise:**
```
Mapeadores que poderiam ser consolidados:

GRUPO 1 - Dados B√°sicos (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosPrincipais
‚îú‚îÄ‚îÄ mapDadosProduto
‚îî‚îÄ‚îÄ mapDadosClassificacao

GRUPO 2 - Financeiro (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosFinanceiros
‚îî‚îÄ‚îÄ mapDadosPagamento

GRUPO 3 - Comunica√ß√£o (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosMensagens
‚îú‚îÄ‚îÄ mapDadosTimeline
‚îî‚îÄ‚îÄ mapDadosAnexos

GRUPO 4 - Tracking (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosRastreamento
‚îî‚îÄ‚îÄ mapDadosReview

GRUPO 5 - Contextual (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosMediacao
‚îú‚îÄ‚îÄ mapDadosTroca
‚îî‚îÄ‚îÄ mapDadosAdicionais

GRUPO 6 - Metadata (podem virar 1 mapeador):
‚îú‚îÄ‚îÄ mapDadosFlags
‚îú‚îÄ‚îÄ mapDadosQualidade
‚îú‚îÄ‚îÄ mapDadosReputacao
‚îî‚îÄ‚îÄ mapDadosSLA

GRUPO 7 - Raw:
‚îî‚îÄ‚îÄ mapDadosBrutos (manter)
```

**Impacto:**
- 18 arquivos para manter
- L√≥gica fragmentada
- Dif√≠cil entender fluxo completo

**Solu√ß√£o:**
```typescript
// ‚úÖ CONSOLIDAR EM 7 MAPEADORES
export const mapBasicData = (data) => ({
  ...mapDadosPrincipais(data),
  ...mapDadosProduto(data),
  ...mapDadosClassificacao(data)
});

export const mapFinancialData = (data) => ({
  ...mapDadosFinanceiros(data),
  ...mapDadosPagamento(data)
});

// Etc... 18 ‚Üí 7 mapeadores
```

---

### 8. ‚è±Ô∏è PERFORMANCE: Processamento Ineficiente

**Problema:**
- Dados processados m√∫ltiplas vezes
- 105 colunas √ó 30 devolu√ß√µes = 3.150 campos processados

**Fluxo Atual:**
```
1. Edge Function busca da API (15s)
   ‚îî‚îÄ‚îÄ Processa 105 colunas √ó 30 items = 3.150 campos
   
2. Frontend recebe dados (1s)
   
3. useDevolucoesBusca mapeia novamente (5s)
   ‚îî‚îÄ‚îÄ 18 mapeadores √ó 30 items = 540 chamadas
   
4. useDevolucoes aplica filtros (2s)
   ‚îî‚îÄ‚îÄ applyAllFilters √ó 30 items
   
5. Renderiza tabela (1s)

TOTAL: ~24s ‚ö†Ô∏è
```

**Evid√™ncia nos Logs:**
```
üì¶ Processando claim 5306953740... (t=0s)
üéâ Total de claims processados: 30 (t=15s)
// 15 segundos s√≥ no processamento
```

**Solu√ß√£o:**
```typescript
// ‚úÖ OTIMIZA√á√ïES:
1. Edge function j√° retorna dados mapeados
2. Frontend s√≥ aplica filtros (n√£o mapeia)
3. Lazy load de detalhes (carregar sob demanda)
4. Cache de reasons pr√©-populado

Tempo estimado: ~8-12s (50% faster)
```

---

## üêõ BUGS POTENCIAIS

### 1. Race Condition em Filtros
```typescript
// useDevolucoes.ts linha 200-207
useEffect(() => {
  if (selectedAccountIds && selectedAccountIds.length > 0) {
    setAdvancedFilters(prev => ({
      ...prev,
      contasSelecionadas: selectedAccountIds
    }));
  }
}, [selectedAccountIds]);

// ‚ùå PROBLEMA: Se selectedAccountIds mudar durante busca,
// filtros podem ficar inconsistentes
```

### 2. Memory Leak em Cache
```typescript
// DevolucaoCacheService.ts
class ReasonsCacheService {
  private cache = new Map<string, any>();
  // ‚ùå PROBLEMA: Cache nunca √© limpo
  // Pode crescer indefinidamente
}
```

### 3. Infinite Loop Potencial
```typescript
// useDevolucoes.ts linha 134-145
const buscarComFiltros = useCallback(async (filtros) => {
  const resultado = await busca.buscarComFiltrosAvancados(filtros, mlAccounts);
  if (resultado) {
    setDevolucoes(resultado);
    // ‚ùå PROBLEMA: Se resultado mudar, pode retriggerar busca
  }
}, [busca, mlAccounts]);
// busca e mlAccounts podem mudar frequentemente
```

---

## üìä DUPLICIDADES DETALHADAS

### C√≥digo Duplicado:

#### 1. Valida√ß√£o de Contas (3 locais)
```typescript
// MLOrdersCompletas.tsx linha 36-39
if (mlAccounts && mlAccounts.length > 0 && selectedAccountIds.length === 0) {
  setSelectedAccountIds(mlAccounts.map(acc => acc.id));
}

// useDevolucoesBusca.ts linha 148-155
const contasParaBuscar = filtros.contasSelecionadas?.length 
  ? filtros.contasSelecionadas 
  : mlAccounts.map(acc => acc.id);

if (!contasParaBuscar || contasParaBuscar.length === 0) {
  toast.error('Nenhuma conta ML dispon√≠vel');
  return [];
}

// useDevolucoes.ts linha 91-93 (createInitialFilters)
contasSelecionadas: selectedAccountIds?.length 
  ? selectedAccountIds 
  : mlAccounts?.map(acc => acc.id) || []
```

#### 2. Aplica√ß√£o de Filtros (2 locais)
```typescript
// useDevolucoes.ts linha 169-171
const devolucoesFiltradas = useMemo(() => {
  return applyAllFilters(devolucoes, advancedFilters);
}, [devolucoes, advancedFilters]);

// FilterUtils.ts linha 1-50
export const applyAllFilters = (vendas, filters) => {
  // Mesma l√≥gica
}
```

#### 3. C√°lculo de Stats (2 locais)
```typescript
// useDevolucoes.ts linha 287-296
const stats = useMemo(() => ({
  total: devolucoesFiltradas.length,
  pendentes: devolucoesFiltradas.filter(d => d.status_devolucao === 'with_claims').length,
  concluidas: devolucoesFiltradas.filter(d => d.status_devolucao === 'completed').length,
  canceladas: devolucoesFiltradas.filter(d => d.status_devolucao === 'cancelled').length,
}), [devolucoesFiltradas]);

// DevolucaoStatsCards.tsx
// Recalcula as mesmas stats no componente
```

---

## üî• PROBLEMAS DE ESTADO

### 1. M√∫ltiplos Sources of Truth
```
Estado de Devolu√ß√µes gerenciado em:
‚îú‚îÄ‚îÄ useDevolucoes (devolucoes: any[])
‚îú‚îÄ‚îÄ useDevolucoesBusca (todasDevolucoes: any[])
‚îî‚îÄ‚îÄ DevolucaoAvancadasTab (selectedDevolucao)

Estado de Loading gerenciado em:
‚îú‚îÄ‚îÄ useDevolucoes (loading: boolean)
‚îú‚îÄ‚îÄ useDevolucoesBusca (loading: boolean)
‚îî‚îÄ‚îÄ DevolucaoAvancadasTab (isRefreshing)

Estado de Filtros gerenciado em:
‚îú‚îÄ‚îÄ useDevolucoes (advancedFilters)
‚îú‚îÄ‚îÄ useDevolucoes (draftFilters)
‚îî‚îÄ‚îÄ LocalStorage (cached filters)
```

### 2. Props Drilling
```
MLOrdersCompletas
‚îú‚îÄ‚îÄ selectedAccountIds (prop)
‚îî‚îÄ‚îÄ DevolucaoAvancadasTab
    ‚îú‚îÄ‚îÄ selectedAccountIds (prop)
    ‚îî‚îÄ‚îÄ useDevolucoes
        ‚îú‚îÄ‚îÄ selectedAccountIds (param)
        ‚îî‚îÄ‚îÄ createInitialFilters
            ‚îî‚îÄ‚îÄ selectedAccountIds (usado)
```

---

## üìà IMPACTO DOS ERROS

### Performance:
```
Tempo de Carregamento:
‚îú‚îÄ‚îÄ Edge Function: 15-20s (‚ùå Lento)
‚îú‚îÄ‚îÄ Frontend Mapping: 5-8s (‚ùå Desnecess√°rio)
‚îú‚îÄ‚îÄ Filtros: 2-3s (‚ö†Ô∏è Ok)
‚îî‚îÄ‚îÄ Render: 1-2s (‚úÖ Ok)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL: 23-33s ‚ùå

Ideal: 8-12s
Atual: 23-33s
Diferen√ßa: +15-21s (2-3x mais lento)
```

### Confiabilidade:
```
Taxa de Sucesso:
‚îú‚îÄ‚îÄ Claims processados: 30/30 (100%) ‚úÖ
‚îú‚îÄ‚îÄ Pedidos encontrados: 26/30 (87%) ‚ö†Ô∏è
‚îú‚îÄ‚îÄ Media√ß√µes encontradas: 3/30 (10%) ‚ùå
‚îî‚îÄ‚îÄ Dados completos: ~60% ‚ö†Ô∏è
```

### Experi√™ncia do Usu√°rio:
```
Problemas:
‚îú‚îÄ‚îÄ Loading muito longo (23-33s)
‚îú‚îÄ‚îÄ Dados incompletos (40% sem detalhes)
‚îú‚îÄ‚îÄ Erros silenciosos (sem feedback)
‚îî‚îÄ‚îÄ UI trava durante processamento
```

---

## ‚úÖ PLANO DE CORRE√á√ÉO PRIORIZADO

### üî¥ URGENTE (Fix Hoje):
1. **Erro 404 de Pedidos** ‚Üí Marcar como `not_found` em vez de falhar
2. **Cleanup AbortController** ‚Üí Adicionar useEffect cleanup
3. **Consolidar Loading States** ‚Üí Usar s√≥ um loading

### üü° IMPORTANTE (Fix Esta Semana):
4. **Duplicidade de Filtros** ‚Üí Centralizar em FilterUtils
5. **Mapeadores** ‚Üí Consolidar 18 ‚Üí 7
6. **Cache Memory Leak** ‚Üí Adicionar cleanup e TTL

### üü¢ MELHORIAS (Fix Pr√≥xima Sprint):
7. **Refatorar ml-api-direct** ‚Üí Dividir em m√≥dulos
8. **Lazy Loading** ‚Üí Carregar detalhes sob demanda
9. **Logs Estruturados** ‚Üí Melhorar observabilidade

---

## üìä RESUMO EXECUTIVO

**Erros Cr√≠ticos:** 8  
**Duplicidades:** 12 locais  
**Bugs Potenciais:** 3  
**Performance Issues:** 5  

**Status Geral:** ‚ö†Ô∏è **MODERADO**  
- Sistema funciona (30 claims processados)
- Mas com muitos problemas de qualidade
- Performance 2-3x mais lenta que deveria
- 40% dos dados incompletos

**A√ß√£o Imediata:** Come√ßar pelos 3 itens URGENTES para melhorar confiabilidade
