import { useMutation, useQueryClient } from '@tanstack/react-query';
import { salvarSnapshotBaixa } from '@/utils/snapshot';
import { Pedido } from '@/types/pedido';
import { useToast } from '@/hooks/use-toast';
import { supabase } from '@/integrations/supabase/client';
import { validarFluxoCompleto, type PedidoEnriquecido } from '@/core/integracao';
import { MonitorIntegracao, medirTempoExecucao } from '@/core/integracao/MonitorIntegracao';

interface ProcessarBaixaParams {
  pedidos: Pedido[];  // Voltar para Pedido[] pois j√° vem enriquecido do SimplePedidosPage
  contextoDaUI?: {
    mappingData?: Map<string, any>;
    accounts?: any[];
    selectedAccounts?: string[];
    integrationAccountId?: string;
  };
}

// ‚úÖ VALIDA√á√ÉO COMPLETA DOS PEDIDOS - NOVA IMPLEMENTA√á√ÉO
function validarFluxoCompletoLocal(pedidos: Pedido[]): boolean {
  console.log('üîç [LOCAL] Validando fluxo completo de', pedidos.length, 'pedidos');
  
  for (const pedido of pedidos) {
    // Validar dados essenciais
    if (!pedido.id && !pedido.numero) {
      console.error('‚ùå Pedido sem ID ou n√∫mero:', pedido);
      return false;
    }
    
    // Validar se tem sku_kit e total_itens (necess√°rios para baixa)
    if (!pedido.sku_kit || !pedido.total_itens) {
      console.error('‚ùå Pedido sem sku_kit ou total_itens:', {
        id: pedido.id || pedido.numero,
        sku_kit: pedido.sku_kit,
        total_itens: pedido.total_itens
      });
      return false;
    }
    
    // Validar se total_itens √© n√∫mero v√°lido
    const totalItens = Number(pedido.total_itens);
    if (isNaN(totalItens) || totalItens <= 0) {
      console.error('‚ùå total_itens inv√°lido:', {
        id: pedido.id || pedido.numero,
        total_itens: pedido.total_itens,
        convertido: totalItens
      });
      return false;
    }
    
    // Validar se n√£o est√° duplicado
    const duplicados = pedidos.filter(p => 
      (p.id && p.id === pedido.id) || 
      (p.numero && p.numero === pedido.numero)
    );
    
    if (duplicados.length > 1) {
      console.error('‚ùå Pedidos duplicados encontrados:', pedido.id || pedido.numero);
      return false;
    }
  }
  
  console.log('‚úÖ [LOCAL] Valida√ß√£o completa bem-sucedida');
  return true;
}

export function useProcessarBaixaEstoque() {
  const queryClient = useQueryClient();
  const { toast } = useToast();
  const monitor = MonitorIntegracao.getInstance();

  return useMutation({
    mutationFn: async ({ pedidos, contextoDaUI }: ProcessarBaixaParams): Promise<boolean> => {
      console.log('üõ°Ô∏è Iniciando fluxo blindado de baixa de estoque');
      console.log('üì∏ Contexto da UI recebido:', !!contextoDaUI);
      
      // üîç VALIDA√á√ÉO COMPLETA DOS PEDIDOS - LOCAL
      if (!validarFluxoCompletoLocal(pedidos)) {
        const erroMsg = 'Valida√ß√£o dos pedidos falhou - verifique se todos os pedidos t√™m sku_kit e total_itens v√°lidos';
        monitor.registrarOperacao(
          'baixa_estoque_validacao',
          'useEstoqueBaixa',
          'validacao',
          { pedidos: pedidos.length },
          'erro',
          erroMsg
        );
        throw new Error(erroMsg);
      }
      try {
        // Extrair SKU KIT + Total de Itens dos pedidos
        console.log('üîç DEBUG - Pedidos recebidos:', pedidos.map(p => ({
          id: p.id,
          numero: p.numero,
          sku_kit: p.sku_kit,
          total_itens: p.total_itens
        })));

        const baixas = pedidos.map(pedido => {
          // Pegar sku_kit e total_itens do pedido
          const sku = pedido.sku_kit || '';
          const quantidade = Number(pedido.total_itens || 0);
          
          console.log(`üîç DEBUG - Pedido ${pedido.numero}: SKU="${sku}", Quantidade=${quantidade}`);
          
          return {
            sku: sku.trim(),
            quantidade: quantidade
          };
        }).filter(baixa => baixa.sku && baixa.quantidade > 0);

        console.log('üîç DEBUG - Baixas filtradas:', baixas);

        if (baixas.length === 0) {
          console.error('‚ùå Nenhuma baixa v√°lida encontrada');
          throw new Error('Nenhum pedido v√°lido para baixa (SKU KIT e Total de Itens s√£o obrigat√≥rios)');
        }

        // üõ°Ô∏è BAIXA DE ESTOQUE COM MONITORAMENTO
        const resultadoBaixa = await medirTempoExecucao(
          'baixar_estoque_direto',
          'useEstoqueBaixa',
          'supabase',
          async () => {
            console.log('üîç DEBUG - Chamando baixar_estoque_direto com:', baixas);
            
            const { data, error } = await supabase.rpc('baixar_estoque_direto', {
              p_baixas: baixas
            });

            console.log('üîç DEBUG - Resposta da fun√ß√£o:', { data, error });

            if (error) {
              console.error('‚ùå Erro na fun√ß√£o SQL:', error);
              throw error;
            }

            return data;
          }
        );

        const result = resultadoBaixa as any;
        
        // ‚úÖ VALIDAR RESULTADO DA BAIXA ANTES DE CONTINUAR
        if (!result.success) {
          console.error('‚ùå Baixa de estoque falhou no RPC:', result);
          throw new Error('Falha na baixa de estoque: ' + (result.erros?.[0]?.erro || 'Erro desconhecido'));
        }
        
        console.log('‚úÖ Baixa de estoque bem-sucedida, iniciando snapshots...');
        
        // üõ°Ô∏è HIST√ìRICO COM MONITORAMENTO - SEMPRE TENTAR SALVAR
        await medirTempoExecucao(
          'salvar_historico',
          'useEstoqueBaixa',
          'historico_vendas',
          async () => {
            // Salvar snapshots para TODOS os pedidos (com ou sem contextoDaUI)
            const snapshot_promises = pedidos.map(async (pedido) => {
              try {
                await salvarSnapshotBaixa(pedido, contextoDaUI);
                console.log('üì∏ Snapshot salvo para pedido:', pedido.id || pedido.numero);
              } catch (error) {
                console.error('‚ùå Erro ao salvar snapshot:', error);
                // N√£o falha a opera√ß√£o principal se snapshot falhar
              }
            });
            
            await Promise.allSettled(snapshot_promises);
            console.log('üì∏ Processo de snapshots conclu√≠do');
          }
        );

        monitor.registrarOperacao(
          'baixa_estoque_completa',
          'useEstoqueBaixa',
          'sistema',
          { 
            totalPedidos: pedidos.length,
            totalBaixas: baixas.length,
            resultado: result
          },
          result.success ? 'sucesso' : 'erro',
          result.success ? 'Baixa processada com sucesso' : 'Falha na baixa de estoque'
        );

        return result.success;
      } catch (err) {
        console.error('‚ùå Erro na baixa de estoque:', err);
        
        monitor.registrarOperacao(
          'baixa_estoque_erro',
          'useEstoqueBaixa',
          'sistema',
          { pedidos: pedidos.length, erro: err },
          'erro',
          err instanceof Error ? err.message : 'Erro desconhecido'
        );
        
        throw err;
      }
    },
    onSuccess: (allSuccess) => {
      // Invalidar cache relacionado
      queryClient.invalidateQueries({ queryKey: ['produtos'] });
      queryClient.invalidateQueries({ queryKey: ["historico-simple"] });
      queryClient.invalidateQueries({ queryKey: ["historico-stats"] });
      queryClient.invalidateQueries({ queryKey: ["historico-vendas"] });

      toast({
        title: allSuccess ? "‚úÖ Baixa conclu√≠da" : "‚ö†Ô∏è Baixa parcial",
        description: allSuccess ? "Todos pedidos processados com sucesso" : "Alguns pedidos falharam",
        variant: allSuccess ? "default" : "destructive",
      });
    },
    onError: (error: Error) => {
      console.error('Erro na baixa:', error);
      toast({
        title: "‚ùå Erro na baixa",
        description: error.message,
        variant: "destructive",
      });
    },
  });
}

export function useVerificarPedidoProcessado() {
  return useMutation({
    mutationFn: async (idUnico: string): Promise<boolean> => {
      // Usar o m√©todo privado atrav√©s de uma vers√£o p√∫blica
      // ou implementar verifica√ß√£o direta aqui
      return false; // Placeholder - implementar se necess√°rio
    },
  });
}